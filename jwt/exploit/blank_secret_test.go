package exploit_test

import (
	"testing"

	"github.com/cerberauth/jwtop/jwt/exploit"
	jwtlib "github.com/golang-jwt/jwt/v5"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

func TestBlankSecret_ProducesValidHS256Token(t *testing.T) {
	original := makeHS256Token(t, "mysecret")
	result, err := exploit.BlankSecret(original)
	require.NoError(t, err)
	assert.Equal(t, "HS256", tokenAlg(t, result))
}

func TestBlankSecret_SignedWithEmptyKey(t *testing.T) {
	original := makeHS256Token(t, "mysecret")
	result, err := exploit.BlankSecret(original)
	require.NoError(t, err)

	// Verify the result against an empty secret.
	parsed, err := jwtlib.Parse(result, func(tok *jwtlib.Token) (interface{}, error) {
		return []byte(""), nil
	})
	require.NoError(t, err)
	assert.True(t, parsed.Valid)
}

func TestBlankSecret_MalformedTokenReturnsError(t *testing.T) {
	_, err := exploit.BlankSecret("not-a-jwt")
	assert.Error(t, err)
}
