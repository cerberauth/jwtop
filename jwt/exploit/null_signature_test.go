package exploit_test

import (
	"testing"

	"github.com/cerberauth/jwtop/jwt/exploit"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

func TestNullSignature_PreservesAlg(t *testing.T) {
	token := makeHS256Token(t, "secret")
	result, err := exploit.NullSignature(token)
	require.NoError(t, err)
	assert.Equal(t, "HS256", tokenAlg(t, result))
}

func TestNullSignature_SignatureIsEmpty(t *testing.T) {
	token := makeHS256Token(t, "secret")
	result, err := exploit.NullSignature(token)
	require.NoError(t, err)
	parts := tokenParts(result)
	require.Len(t, parts, 3)
	assert.Empty(t, parts[2])
}

func TestNullSignature_DifferentFromAlgNone(t *testing.T) {
	token := makeHS256Token(t, "secret")
	noneToken, err := exploit.AlgNone(token)
	require.NoError(t, err)
	nullToken, err := exploit.NullSignature(token)
	require.NoError(t, err)

	assert.NotEqual(t, tokenParts(noneToken)[0], tokenParts(nullToken)[0])
}

func TestNullSignature_MalformedTokenReturnsError(t *testing.T) {
	_, err := exploit.NullSignature("not-a-jwt")
	assert.Error(t, err)
}
