package exploit_test

import (
	"testing"

	"github.com/cerberauth/jwtop/jwt/exploit"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

func TestAlgNone_SetsAlgToNone(t *testing.T) {
	token := makeHS256Token(t, "secret")
	result, err := exploit.AlgNone(token)
	require.NoError(t, err)
	assert.Equal(t, "none", tokenAlg(t, result))
}

func TestAlgNone_SignatureIsEmpty(t *testing.T) {
	token := makeHS256Token(t, "secret")
	result, err := exploit.AlgNone(token)
	require.NoError(t, err)
	parts := tokenParts(result)
	require.Len(t, parts, 3)
	assert.Empty(t, parts[2], "signature segment should be empty")
}

func TestAlgNone_MalformedTokenReturnsError(t *testing.T) {
	_, err := exploit.AlgNone("not-a-jwt")
	assert.Error(t, err)
}

func TestAlgNoneAll_ReturnsAllVariants(t *testing.T) {
	token := makeHS256Token(t, "secret")
	results, err := exploit.AlgNoneAll(token)
	require.NoError(t, err)
	assert.Len(t, results, len(exploit.AlgNoneVariants))
}

func TestAlgNoneAll_VariantsHaveCorrectAlg(t *testing.T) {
	token := makeHS256Token(t, "secret")
	results, err := exploit.AlgNoneAll(token)
	require.NoError(t, err)

	for i, variant := range exploit.AlgNoneVariants {
		assert.Equal(t, variant, tokenAlg(t, results[i]),
			"token %d should have alg=%s", i, variant)
	}
}

func TestAlgNoneAll_AllSignaturesEmpty(t *testing.T) {
	token := makeHS256Token(t, "secret")
	results, err := exploit.AlgNoneAll(token)
	require.NoError(t, err)

	for i, r := range results {
		parts := tokenParts(r)
		require.Len(t, parts, 3)
		assert.Empty(t, parts[2], "token %d signature should be empty", i)
	}
}
