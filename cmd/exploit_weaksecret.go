package cmd

import (
	"fmt"
	"os"

	"github.com/cerberauth/jwtop/jwt/exploit"
	"github.com/cerberauth/x/telemetryx"
	"github.com/spf13/cobra"
	"go.opentelemetry.io/otel/attribute"
	"go.opentelemetry.io/otel/metric"
)

var (
	exploitWeakSecretWordlist string
	exploitWeakSecretSecrets  []string
	exploitWeakSecretWorkers  int
)

var exploitWeakSecretCmd = &cobra.Command{
	Use:   "weaksecret <token>",
	Short: "Brute-force the HMAC signing secret against a built-in wordlist",
	Long: `Dictionary-attack the HMAC signing secret of an HS256/HS384/HS512 token.

The built-in wordlist (embedded from danielmiessler/SecLists) is tried first,
then any --wordlist file, then any --secret values supplied on the command line.

On success the recovered secret is printed to stdout.
On failure the command exits with a non-zero status.`,
	Args: cobra.ExactArgs(1),
	RunE: func(cmd *cobra.Command, args []string) error {
		telemetryMeter := telemetryx.GetMeterProvider().Meter(exploitOtelName)
		successCounter, _ := telemetryMeter.Int64Counter("exploit.weaksecret.success.counter")
		notFoundCounter, _ := telemetryMeter.Int64Counter("exploit.weaksecret.notfound.counter")
		errorCounter, _ := telemetryMeter.Int64Counter("exploit.weaksecret.error.counter")
		ctx := cmd.Context()

		candidates := exploit.WeakSecrets()
		if exploitWeakSecretWordlist != "" {
			fromFile, err := exploit.SecretsFromFile(exploitWeakSecretWordlist)
			if err != nil {
				errorCounter.Add(ctx, 1, metric.WithAttributes(attribute.String("error_reason", "wordlist read error")))
				return fmt.Errorf("reading wordlist: %w", err)
			}
			candidates = append(candidates, fromFile...)
		}
		candidates = append(candidates, exploitWeakSecretSecrets...)

		result, err := exploit.CrackSecret(args[0], candidates, exploitWeakSecretWorkers)
		if err != nil {
			errorCounter.Add(ctx, 1, metric.WithAttributes(attribute.String("error_reason", "crack error")))
			return fmt.Errorf("weaksecret: %w", err)
		}
		if !result.Found {
			notFoundCounter.Add(ctx, 1)
			fmt.Fprintln(os.Stderr, "secret not found in dictionary")
			os.Exit(1)
		}
		successCounter.Add(ctx, 1)
		fmt.Println(result.Secret)
		return nil
	},
}

func init() {
	exploitWeakSecretCmd.Flags().StringVar(&exploitWeakSecretWordlist, "wordlist", "", "Path to newline-delimited wordlist file")
	exploitWeakSecretCmd.Flags().StringArrayVar(&exploitWeakSecretSecrets, "secret", nil, "Explicit candidate secret (repeatable)")
	exploitWeakSecretCmd.Flags().IntVar(&exploitWeakSecretWorkers, "workers", 8, "Concurrent workers for brute-force")
	exploitCmd.AddCommand(exploitWeakSecretCmd)
}
